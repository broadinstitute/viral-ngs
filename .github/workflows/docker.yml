name: Build and Test

on:
  push:
    branches:
      - main
      - '**'
    tags:
      - 'v*'
  pull_request:
    branches:
      - main

env:
  QUAY_REPO: quay.io/broadinstitute/viral-ngs
  GHCR_REPO: ghcr.io/broadinstitute/viral-ngs

jobs:
  # Determine which paths changed to enable smart test filtering
  paths-filter:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      core: ${{ steps.filter.outputs.core }}
      assemble: ${{ steps.filter.outputs.assemble }}
      classify: ${{ steps.filter.outputs.classify }}
      phylo: ${{ steps.filter.outputs.phylo }}
      docker: ${{ steps.filter.outputs.docker }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check changed paths
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            core:
              - 'src/viral_ngs/*.py'
              - 'src/viral_ngs/core/**'
              - 'src/viral_ngs/util/**'
              - 'tests/unit/core/**'
              - 'tests/conftest.py'
              - 'docker/requirements/core.txt'
              - 'docker/requirements/core-x86.txt'
              - 'docker/requirements/baseimage.txt'
              - 'docker/Dockerfile.core'
              - 'docker/Dockerfile.baseimage'
              - 'pyproject.toml'
            assemble:
              - 'src/viral_ngs/assemble/**'
              - 'src/viral_ngs/assembly.py'
              - 'tests/unit/assemble/**'
              - 'docker/requirements/assemble.txt'
              - 'docker/Dockerfile.assemble'
            classify:
              - 'src/viral_ngs/classify/**'
              - 'src/viral_ngs/metagenomics.py'
              - 'src/viral_ngs/taxon_filter.py'
              - 'src/viral_ngs/kmer_utils.py'
              - 'tests/unit/classify/**'
              - 'docker/requirements/classify.txt'
              - 'docker/Dockerfile.classify'
            phylo:
              - 'src/viral_ngs/phylo/**'
              - 'src/viral_ngs/interhost.py'
              - 'src/viral_ngs/intrahost.py'
              - 'src/viral_ngs/ncbi.py'
              - 'tests/unit/phylo/**'
              - 'docker/requirements/phylo.txt'
              - 'docker/requirements/phylo-x86.txt'
              - 'docker/Dockerfile.phylo'
            docker:
              - 'docker/**'
              - '.github/workflows/docker.yml'

  # Calculate version from git describe (once, shared by all jobs)
  get-version:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      version: ${{ steps.version.outputs.version }}
      image-tag-prefix: ${{ steps.image-tag.outputs.prefix }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for accurate git describe
          fetch-tags: true

      - name: Get version from git describe
        id: version
        run: |
          # Get version like: v1.25.0 or v1.25.0-42-gabcdef
          # Use --match 'v*' to only match version tags (not archive/* tags)
          RAW_VERSION=$(git describe --tags --always --match 'v*')
          # Strip leading 'v' if present
          RAW_VERSION=${RAW_VERSION#v}

          # Convert to PEP 440 format for setuptools_scm
          # git describe: 1.25.0-42-gabcdef -> PEP 440: 1.25.0.dev42+gabcdef
          if [[ "$RAW_VERSION" =~ ^([0-9]+\.[0-9]+\.[0-9]+)-([0-9]+)-g([a-f0-9]+)$ ]]; then
            VERSION="${BASH_REMATCH[1]}.dev${BASH_REMATCH[2]}+g${BASH_REMATCH[3]}"
          else
            # Clean version tag (e.g., 1.25.0)
            VERSION="$RAW_VERSION"
          fi

          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "Detected version: ${VERSION}"

      - name: Compute Docker image tag prefix
        id: image-tag
        run: |
          # For PRs, github.ref_name is "1020/merge" which contains "/" - invalid in Docker tags
          # Convert to a valid tag prefix: "pr-1020" for PRs, sanitized branch name for branches
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            # Extract PR number from github.ref (refs/pull/1020/merge -> 1020)
            PR_NUMBER="${{ github.event.pull_request.number }}"
            PREFIX="pr-${PR_NUMBER}"
          else
            # For branches/tags, replace "/" with "-" to create valid Docker tags
            PREFIX=$(echo "${{ github.ref_name }}" | sed 's|/|-|g')
          fi
          echo "prefix=${PREFIX}" >> $GITHUB_OUTPUT
          echo "Image tag prefix: ${PREFIX}"

  # ============================================================================
  # BASEIMAGE BUILD JOBS - Native multi-arch builds (no QEMU)
  # AMD64 and ARM64 build in parallel on native runners, then combined
  # ============================================================================

  # Build baseimage for AMD64
  build-baseimage-amd64:
    needs: get-version
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    outputs:
      digest: ${{ steps.build.outputs.digest }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push (amd64)
        id: build
        uses: docker/build-push-action@v6
        with:
          context: .
          file: docker/Dockerfile.baseimage
          platforms: linux/amd64
          push: true
          tags: ${{ env.GHCR_REPO }}:${{ needs.get-version.outputs.image-tag-prefix }}-baseimage-amd64
          cache-from: |
            type=registry,ref=${{ env.GHCR_REPO }}:cache-baseimage-amd64-${{ needs.get-version.outputs.image-tag-prefix }}
            type=registry,ref=${{ env.GHCR_REPO }}:cache-baseimage-amd64-main
          cache-to: type=registry,ref=${{ env.GHCR_REPO }}:cache-baseimage-amd64-${{ needs.get-version.outputs.image-tag-prefix }},mode=max

  # Build baseimage for ARM64 (native runner)
  build-baseimage-arm64:
    needs: get-version
    runs-on: ubuntu-24.04-arm
    permissions:
      contents: read
      packages: write
    outputs:
      digest: ${{ steps.build.outputs.digest }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push (arm64)
        id: build
        uses: docker/build-push-action@v6
        with:
          context: .
          file: docker/Dockerfile.baseimage
          platforms: linux/arm64
          push: true
          tags: ${{ env.GHCR_REPO }}:${{ needs.get-version.outputs.image-tag-prefix }}-baseimage-arm64
          cache-from: |
            type=registry,ref=${{ env.GHCR_REPO }}:cache-baseimage-arm64-${{ needs.get-version.outputs.image-tag-prefix }}
            type=registry,ref=${{ env.GHCR_REPO }}:cache-baseimage-arm64-main
          cache-to: type=registry,ref=${{ env.GHCR_REPO }}:cache-baseimage-arm64-${{ needs.get-version.outputs.image-tag-prefix }},mode=max

  # Create multi-arch manifest for baseimage
  create-manifest-baseimage:
    needs: [get-version, build-baseimage-amd64, build-baseimage-arm64]
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    outputs:
      baseimage-tag: ${{ steps.get-tag.outputs.tag }}

    steps:
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Get baseimage tag
        id: get-tag
        run: echo "tag=${{ needs.get-version.outputs.image-tag-prefix }}-baseimage" >> $GITHUB_OUTPUT

      - name: Create multi-arch manifest
        run: |
          # Create manifest with OCI annotations
          docker buildx imagetools create \
            --annotation "index:org.opencontainers.image.source=https://github.com/broadinstitute/viral-ngs" \
            --annotation "index:org.opencontainers.image.description=Viral genomics analysis tools - base image" \
            --annotation "index:org.opencontainers.image.licenses=MIT" \
            --tag ${{ env.GHCR_REPO }}:${{ steps.get-tag.outputs.tag }} \
            ${{ env.GHCR_REPO }}:${{ needs.get-version.outputs.image-tag-prefix }}-baseimage-amd64 \
            ${{ env.GHCR_REPO }}:${{ needs.get-version.outputs.image-tag-prefix }}-baseimage-arm64

      - name: Create additional tags for main branch
        if: github.ref == 'refs/heads/main'
        run: |
          docker buildx imagetools create \
            --annotation "index:org.opencontainers.image.source=https://github.com/broadinstitute/viral-ngs" \
            --annotation "index:org.opencontainers.image.description=Viral genomics analysis tools - base image" \
            --annotation "index:org.opencontainers.image.licenses=MIT" \
            --tag ${{ env.GHCR_REPO }}:baseimage \
            ${{ env.GHCR_REPO }}:${{ needs.get-version.outputs.image-tag-prefix }}-baseimage-amd64 \
            ${{ env.GHCR_REPO }}:${{ needs.get-version.outputs.image-tag-prefix }}-baseimage-arm64

      - name: Create version tags
        if: github.ref_type == 'tag'
        run: |
          VERSION="${{ github.ref_name }}"
          MAJOR_MINOR=$(echo "$VERSION" | sed -E 's/^v?([0-9]+\.[0-9]+).*/\1/')

          # Create version tag
          docker buildx imagetools create \
            --annotation "index:org.opencontainers.image.source=https://github.com/broadinstitute/viral-ngs" \
            --annotation "index:org.opencontainers.image.description=Viral genomics analysis tools - base image" \
            --annotation "index:org.opencontainers.image.licenses=MIT" \
            --tag ${{ env.GHCR_REPO }}:${VERSION}-baseimage \
            ${{ env.GHCR_REPO }}:${{ needs.get-version.outputs.image-tag-prefix }}-baseimage-amd64 \
            ${{ env.GHCR_REPO }}:${{ needs.get-version.outputs.image-tag-prefix }}-baseimage-arm64

          # Create major.minor tag
          docker buildx imagetools create \
            --annotation "index:org.opencontainers.image.source=https://github.com/broadinstitute/viral-ngs" \
            --annotation "index:org.opencontainers.image.description=Viral genomics analysis tools - base image" \
            --annotation "index:org.opencontainers.image.licenses=MIT" \
            --tag ${{ env.GHCR_REPO }}:${MAJOR_MINOR}-baseimage \
            ${{ env.GHCR_REPO }}:${{ needs.get-version.outputs.image-tag-prefix }}-baseimage-amd64 \
            ${{ env.GHCR_REPO }}:${{ needs.get-version.outputs.image-tag-prefix }}-baseimage-arm64

  # ============================================================================
  # CORE BUILD JOBS - Native multi-arch builds
  # ============================================================================

  # Build core for AMD64 (depends on baseimage-amd64, not manifest)
  build-core-amd64:
    needs: [get-version, build-baseimage-amd64]
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    outputs:
      digest: ${{ steps.build.outputs.digest }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push (amd64)
        id: build
        uses: docker/build-push-action@v6
        with:
          context: .
          file: docker/Dockerfile.core
          platforms: linux/amd64
          push: true
          tags: ${{ env.GHCR_REPO }}:${{ needs.get-version.outputs.image-tag-prefix }}-core-amd64
          build-args: |
            BASEIMAGE=${{ env.GHCR_REPO }}:${{ needs.get-version.outputs.image-tag-prefix }}-baseimage-amd64
            VERSION=${{ needs.get-version.outputs.version }}
          cache-from: |
            type=registry,ref=${{ env.GHCR_REPO }}:cache-core-amd64-${{ needs.get-version.outputs.image-tag-prefix }}
            type=registry,ref=${{ env.GHCR_REPO }}:cache-core-amd64-main
            type=registry,ref=${{ env.GHCR_REPO }}:cache-baseimage-amd64-${{ needs.get-version.outputs.image-tag-prefix }}
            type=registry,ref=${{ env.GHCR_REPO }}:cache-baseimage-amd64-main
          cache-to: type=registry,ref=${{ env.GHCR_REPO }}:cache-core-amd64-${{ needs.get-version.outputs.image-tag-prefix }},mode=max

  # Build core for ARM64 (depends on baseimage-arm64, not manifest)
  build-core-arm64:
    needs: [get-version, build-baseimage-arm64]
    runs-on: ubuntu-24.04-arm
    permissions:
      contents: read
      packages: write
    outputs:
      digest: ${{ steps.build.outputs.digest }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push (arm64)
        id: build
        uses: docker/build-push-action@v6
        with:
          context: .
          file: docker/Dockerfile.core
          platforms: linux/arm64
          push: true
          tags: ${{ env.GHCR_REPO }}:${{ needs.get-version.outputs.image-tag-prefix }}-core-arm64
          build-args: |
            BASEIMAGE=${{ env.GHCR_REPO }}:${{ needs.get-version.outputs.image-tag-prefix }}-baseimage-arm64
            VERSION=${{ needs.get-version.outputs.version }}
          cache-from: |
            type=registry,ref=${{ env.GHCR_REPO }}:cache-core-arm64-${{ needs.get-version.outputs.image-tag-prefix }}
            type=registry,ref=${{ env.GHCR_REPO }}:cache-core-arm64-main
            type=registry,ref=${{ env.GHCR_REPO }}:cache-baseimage-arm64-${{ needs.get-version.outputs.image-tag-prefix }}
            type=registry,ref=${{ env.GHCR_REPO }}:cache-baseimage-arm64-main
          cache-to: type=registry,ref=${{ env.GHCR_REPO }}:cache-core-arm64-${{ needs.get-version.outputs.image-tag-prefix }},mode=max

  # Create multi-arch manifest for core
  create-manifest-core:
    needs: [get-version, build-core-amd64, build-core-arm64]
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    outputs:
      core-tag: ${{ steps.get-tag.outputs.tag }}

    steps:
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Get core tag
        id: get-tag
        run: echo "tag=${{ needs.get-version.outputs.image-tag-prefix }}-core" >> $GITHUB_OUTPUT

      - name: Create multi-arch manifest
        run: |
          docker buildx imagetools create \
            --annotation "index:org.opencontainers.image.source=https://github.com/broadinstitute/viral-ngs" \
            --annotation "index:org.opencontainers.image.description=Viral genomics analysis tools - core utilities" \
            --annotation "index:org.opencontainers.image.licenses=MIT" \
            --tag ${{ env.GHCR_REPO }}:${{ steps.get-tag.outputs.tag }} \
            ${{ env.GHCR_REPO }}:${{ needs.get-version.outputs.image-tag-prefix }}-core-amd64 \
            ${{ env.GHCR_REPO }}:${{ needs.get-version.outputs.image-tag-prefix }}-core-arm64

      - name: Create additional tags for main branch
        if: github.ref == 'refs/heads/main'
        run: |
          docker buildx imagetools create \
            --annotation "index:org.opencontainers.image.source=https://github.com/broadinstitute/viral-ngs" \
            --annotation "index:org.opencontainers.image.description=Viral genomics analysis tools - core utilities" \
            --annotation "index:org.opencontainers.image.licenses=MIT" \
            --tag ${{ env.GHCR_REPO }}:core \
            ${{ env.GHCR_REPO }}:${{ needs.get-version.outputs.image-tag-prefix }}-core-amd64 \
            ${{ env.GHCR_REPO }}:${{ needs.get-version.outputs.image-tag-prefix }}-core-arm64

      - name: Create version tags
        if: github.ref_type == 'tag'
        run: |
          VERSION="${{ github.ref_name }}"
          MAJOR_MINOR=$(echo "$VERSION" | sed -E 's/^v?([0-9]+\.[0-9]+).*/\1/')

          docker buildx imagetools create \
            --annotation "index:org.opencontainers.image.source=https://github.com/broadinstitute/viral-ngs" \
            --annotation "index:org.opencontainers.image.description=Viral genomics analysis tools - core utilities" \
            --annotation "index:org.opencontainers.image.licenses=MIT" \
            --tag ${{ env.GHCR_REPO }}:${VERSION}-core \
            ${{ env.GHCR_REPO }}:${{ needs.get-version.outputs.image-tag-prefix }}-core-amd64 \
            ${{ env.GHCR_REPO }}:${{ needs.get-version.outputs.image-tag-prefix }}-core-arm64

          docker buildx imagetools create \
            --annotation "index:org.opencontainers.image.source=https://github.com/broadinstitute/viral-ngs" \
            --annotation "index:org.opencontainers.image.description=Viral genomics analysis tools - core utilities" \
            --annotation "index:org.opencontainers.image.licenses=MIT" \
            --tag ${{ env.GHCR_REPO }}:${MAJOR_MINOR}-core \
            ${{ env.GHCR_REPO }}:${{ needs.get-version.outputs.image-tag-prefix }}-core-amd64 \
            ${{ env.GHCR_REPO }}:${{ needs.get-version.outputs.image-tag-prefix }}-core-arm64

  # ============================================================================
  # ASSEMBLE BUILD JOBS - Native multi-arch builds
  # ============================================================================

  # Build assemble for AMD64
  build-assemble-amd64:
    needs: [get-version, build-core-amd64]
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    outputs:
      digest: ${{ steps.build.outputs.digest }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push (amd64)
        id: build
        uses: docker/build-push-action@v6
        with:
          context: .
          file: docker/Dockerfile.assemble
          platforms: linux/amd64
          push: true
          tags: ${{ env.GHCR_REPO }}:${{ needs.get-version.outputs.image-tag-prefix }}-assemble-amd64
          build-args: |
            BASEIMAGE=${{ env.GHCR_REPO }}:${{ needs.get-version.outputs.image-tag-prefix }}-core-amd64
            VERSION=${{ needs.get-version.outputs.version }}
          cache-from: |
            type=registry,ref=${{ env.GHCR_REPO }}:cache-assemble-amd64-${{ needs.get-version.outputs.image-tag-prefix }}
            type=registry,ref=${{ env.GHCR_REPO }}:cache-assemble-amd64-main
            type=registry,ref=${{ env.GHCR_REPO }}:cache-core-amd64-${{ needs.get-version.outputs.image-tag-prefix }}
            type=registry,ref=${{ env.GHCR_REPO }}:cache-core-amd64-main
          cache-to: type=registry,ref=${{ env.GHCR_REPO }}:cache-assemble-amd64-${{ needs.get-version.outputs.image-tag-prefix }},mode=max

  # Build assemble for ARM64
  build-assemble-arm64:
    needs: [get-version, build-core-arm64]
    runs-on: ubuntu-24.04-arm
    permissions:
      contents: read
      packages: write
    outputs:
      digest: ${{ steps.build.outputs.digest }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push (arm64)
        id: build
        uses: docker/build-push-action@v6
        with:
          context: .
          file: docker/Dockerfile.assemble
          platforms: linux/arm64
          push: true
          tags: ${{ env.GHCR_REPO }}:${{ needs.get-version.outputs.image-tag-prefix }}-assemble-arm64
          build-args: |
            BASEIMAGE=${{ env.GHCR_REPO }}:${{ needs.get-version.outputs.image-tag-prefix }}-core-arm64
            VERSION=${{ needs.get-version.outputs.version }}
          cache-from: |
            type=registry,ref=${{ env.GHCR_REPO }}:cache-assemble-arm64-${{ needs.get-version.outputs.image-tag-prefix }}
            type=registry,ref=${{ env.GHCR_REPO }}:cache-assemble-arm64-main
            type=registry,ref=${{ env.GHCR_REPO }}:cache-core-arm64-${{ needs.get-version.outputs.image-tag-prefix }}
            type=registry,ref=${{ env.GHCR_REPO }}:cache-core-arm64-main
          cache-to: type=registry,ref=${{ env.GHCR_REPO }}:cache-assemble-arm64-${{ needs.get-version.outputs.image-tag-prefix }},mode=max

  # Create multi-arch manifest for assemble
  create-manifest-assemble:
    needs: [get-version, build-assemble-amd64, build-assemble-arm64]
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    outputs:
      assemble-tag: ${{ steps.get-tag.outputs.tag }}

    steps:
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Get assemble tag
        id: get-tag
        run: echo "tag=${{ needs.get-version.outputs.image-tag-prefix }}-assemble" >> $GITHUB_OUTPUT

      - name: Create multi-arch manifest
        run: |
          docker buildx imagetools create \
            --annotation "index:org.opencontainers.image.source=https://github.com/broadinstitute/viral-ngs" \
            --annotation "index:org.opencontainers.image.description=Viral genomics analysis tools - assembly" \
            --annotation "index:org.opencontainers.image.licenses=MIT" \
            --tag ${{ env.GHCR_REPO }}:${{ steps.get-tag.outputs.tag }} \
            ${{ env.GHCR_REPO }}:${{ needs.get-version.outputs.image-tag-prefix }}-assemble-amd64 \
            ${{ env.GHCR_REPO }}:${{ needs.get-version.outputs.image-tag-prefix }}-assemble-arm64

      - name: Create additional tags for main branch
        if: github.ref == 'refs/heads/main'
        run: |
          docker buildx imagetools create \
            --annotation "index:org.opencontainers.image.source=https://github.com/broadinstitute/viral-ngs" \
            --annotation "index:org.opencontainers.image.description=Viral genomics analysis tools - assembly" \
            --annotation "index:org.opencontainers.image.licenses=MIT" \
            --tag ${{ env.GHCR_REPO }}:assemble \
            ${{ env.GHCR_REPO }}:${{ needs.get-version.outputs.image-tag-prefix }}-assemble-amd64 \
            ${{ env.GHCR_REPO }}:${{ needs.get-version.outputs.image-tag-prefix }}-assemble-arm64

      - name: Create version tags
        if: github.ref_type == 'tag'
        run: |
          VERSION="${{ github.ref_name }}"
          MAJOR_MINOR=$(echo "$VERSION" | sed -E 's/^v?([0-9]+\.[0-9]+).*/\1/')

          docker buildx imagetools create \
            --annotation "index:org.opencontainers.image.source=https://github.com/broadinstitute/viral-ngs" \
            --annotation "index:org.opencontainers.image.description=Viral genomics analysis tools - assembly" \
            --annotation "index:org.opencontainers.image.licenses=MIT" \
            --tag ${{ env.GHCR_REPO }}:${VERSION}-assemble \
            ${{ env.GHCR_REPO }}:${{ needs.get-version.outputs.image-tag-prefix }}-assemble-amd64 \
            ${{ env.GHCR_REPO }}:${{ needs.get-version.outputs.image-tag-prefix }}-assemble-arm64

          docker buildx imagetools create \
            --annotation "index:org.opencontainers.image.source=https://github.com/broadinstitute/viral-ngs" \
            --annotation "index:org.opencontainers.image.description=Viral genomics analysis tools - assembly" \
            --annotation "index:org.opencontainers.image.licenses=MIT" \
            --tag ${{ env.GHCR_REPO }}:${MAJOR_MINOR}-assemble \
            ${{ env.GHCR_REPO }}:${{ needs.get-version.outputs.image-tag-prefix }}-assemble-amd64 \
            ${{ env.GHCR_REPO }}:${{ needs.get-version.outputs.image-tag-prefix }}-assemble-arm64

  # ============================================================================
  # CLASSIFY BUILD JOBS - Native multi-arch builds
  # ============================================================================

  # Build classify for AMD64
  build-classify-amd64:
    needs: [get-version, build-core-amd64]
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    outputs:
      digest: ${{ steps.build.outputs.digest }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push (amd64)
        id: build
        uses: docker/build-push-action@v6
        with:
          context: .
          file: docker/Dockerfile.classify
          platforms: linux/amd64
          push: true
          tags: ${{ env.GHCR_REPO }}:${{ needs.get-version.outputs.image-tag-prefix }}-classify-amd64
          build-args: |
            BASEIMAGE=${{ env.GHCR_REPO }}:${{ needs.get-version.outputs.image-tag-prefix }}-core-amd64
            VERSION=${{ needs.get-version.outputs.version }}
          cache-from: |
            type=registry,ref=${{ env.GHCR_REPO }}:cache-classify-amd64-${{ needs.get-version.outputs.image-tag-prefix }}
            type=registry,ref=${{ env.GHCR_REPO }}:cache-classify-amd64-main
            type=registry,ref=${{ env.GHCR_REPO }}:cache-core-amd64-${{ needs.get-version.outputs.image-tag-prefix }}
            type=registry,ref=${{ env.GHCR_REPO }}:cache-core-amd64-main
          cache-to: type=registry,ref=${{ env.GHCR_REPO }}:cache-classify-amd64-${{ needs.get-version.outputs.image-tag-prefix }},mode=max

  # Build classify for ARM64
  build-classify-arm64:
    needs: [get-version, build-core-arm64]
    runs-on: ubuntu-24.04-arm
    permissions:
      contents: read
      packages: write
    outputs:
      digest: ${{ steps.build.outputs.digest }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push (arm64)
        id: build
        uses: docker/build-push-action@v6
        with:
          context: .
          file: docker/Dockerfile.classify
          platforms: linux/arm64
          push: true
          tags: ${{ env.GHCR_REPO }}:${{ needs.get-version.outputs.image-tag-prefix }}-classify-arm64
          build-args: |
            BASEIMAGE=${{ env.GHCR_REPO }}:${{ needs.get-version.outputs.image-tag-prefix }}-core-arm64
            VERSION=${{ needs.get-version.outputs.version }}
          cache-from: |
            type=registry,ref=${{ env.GHCR_REPO }}:cache-classify-arm64-${{ needs.get-version.outputs.image-tag-prefix }}
            type=registry,ref=${{ env.GHCR_REPO }}:cache-classify-arm64-main
            type=registry,ref=${{ env.GHCR_REPO }}:cache-core-arm64-${{ needs.get-version.outputs.image-tag-prefix }}
            type=registry,ref=${{ env.GHCR_REPO }}:cache-core-arm64-main
          cache-to: type=registry,ref=${{ env.GHCR_REPO }}:cache-classify-arm64-${{ needs.get-version.outputs.image-tag-prefix }},mode=max

  # Create multi-arch manifest for classify
  create-manifest-classify:
    needs: [get-version, build-classify-amd64, build-classify-arm64]
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    outputs:
      classify-tag: ${{ steps.get-tag.outputs.tag }}

    steps:
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Get classify tag
        id: get-tag
        run: echo "tag=${{ needs.get-version.outputs.image-tag-prefix }}-classify" >> $GITHUB_OUTPUT

      - name: Create multi-arch manifest
        run: |
          docker buildx imagetools create \
            --annotation "index:org.opencontainers.image.source=https://github.com/broadinstitute/viral-ngs" \
            --annotation "index:org.opencontainers.image.description=Viral genomics analysis tools - metagenomic classification" \
            --annotation "index:org.opencontainers.image.licenses=MIT" \
            --tag ${{ env.GHCR_REPO }}:${{ steps.get-tag.outputs.tag }} \
            ${{ env.GHCR_REPO }}:${{ needs.get-version.outputs.image-tag-prefix }}-classify-amd64 \
            ${{ env.GHCR_REPO }}:${{ needs.get-version.outputs.image-tag-prefix }}-classify-arm64

      - name: Create additional tags for main branch
        if: github.ref == 'refs/heads/main'
        run: |
          docker buildx imagetools create \
            --annotation "index:org.opencontainers.image.source=https://github.com/broadinstitute/viral-ngs" \
            --annotation "index:org.opencontainers.image.description=Viral genomics analysis tools - metagenomic classification" \
            --annotation "index:org.opencontainers.image.licenses=MIT" \
            --tag ${{ env.GHCR_REPO }}:classify \
            ${{ env.GHCR_REPO }}:${{ needs.get-version.outputs.image-tag-prefix }}-classify-amd64 \
            ${{ env.GHCR_REPO }}:${{ needs.get-version.outputs.image-tag-prefix }}-classify-arm64

      - name: Create version tags
        if: github.ref_type == 'tag'
        run: |
          VERSION="${{ github.ref_name }}"
          MAJOR_MINOR=$(echo "$VERSION" | sed -E 's/^v?([0-9]+\.[0-9]+).*/\1/')

          docker buildx imagetools create \
            --annotation "index:org.opencontainers.image.source=https://github.com/broadinstitute/viral-ngs" \
            --annotation "index:org.opencontainers.image.description=Viral genomics analysis tools - metagenomic classification" \
            --annotation "index:org.opencontainers.image.licenses=MIT" \
            --tag ${{ env.GHCR_REPO }}:${VERSION}-classify \
            ${{ env.GHCR_REPO }}:${{ needs.get-version.outputs.image-tag-prefix }}-classify-amd64 \
            ${{ env.GHCR_REPO }}:${{ needs.get-version.outputs.image-tag-prefix }}-classify-arm64

          docker buildx imagetools create \
            --annotation "index:org.opencontainers.image.source=https://github.com/broadinstitute/viral-ngs" \
            --annotation "index:org.opencontainers.image.description=Viral genomics analysis tools - metagenomic classification" \
            --annotation "index:org.opencontainers.image.licenses=MIT" \
            --tag ${{ env.GHCR_REPO }}:${MAJOR_MINOR}-classify \
            ${{ env.GHCR_REPO }}:${{ needs.get-version.outputs.image-tag-prefix }}-classify-amd64 \
            ${{ env.GHCR_REPO }}:${{ needs.get-version.outputs.image-tag-prefix }}-classify-arm64

  # ============================================================================
  # PHYLO BUILD JOBS - Native multi-arch builds
  # ============================================================================

  # Build phylo for AMD64
  build-phylo-amd64:
    needs: [get-version, build-core-amd64]
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    outputs:
      digest: ${{ steps.build.outputs.digest }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push (amd64)
        id: build
        uses: docker/build-push-action@v6
        with:
          context: .
          file: docker/Dockerfile.phylo
          platforms: linux/amd64
          push: true
          tags: ${{ env.GHCR_REPO }}:${{ needs.get-version.outputs.image-tag-prefix }}-phylo-amd64
          build-args: |
            BASEIMAGE=${{ env.GHCR_REPO }}:${{ needs.get-version.outputs.image-tag-prefix }}-core-amd64
            VERSION=${{ needs.get-version.outputs.version }}
          cache-from: |
            type=registry,ref=${{ env.GHCR_REPO }}:cache-phylo-amd64-${{ needs.get-version.outputs.image-tag-prefix }}
            type=registry,ref=${{ env.GHCR_REPO }}:cache-phylo-amd64-main
            type=registry,ref=${{ env.GHCR_REPO }}:cache-core-amd64-${{ needs.get-version.outputs.image-tag-prefix }}
            type=registry,ref=${{ env.GHCR_REPO }}:cache-core-amd64-main
          cache-to: type=registry,ref=${{ env.GHCR_REPO }}:cache-phylo-amd64-${{ needs.get-version.outputs.image-tag-prefix }},mode=max

  # Build phylo for ARM64
  build-phylo-arm64:
    needs: [get-version, build-core-arm64]
    runs-on: ubuntu-24.04-arm
    permissions:
      contents: read
      packages: write
    outputs:
      digest: ${{ steps.build.outputs.digest }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push (arm64)
        id: build
        uses: docker/build-push-action@v6
        with:
          context: .
          file: docker/Dockerfile.phylo
          platforms: linux/arm64
          push: true
          tags: ${{ env.GHCR_REPO }}:${{ needs.get-version.outputs.image-tag-prefix }}-phylo-arm64
          build-args: |
            BASEIMAGE=${{ env.GHCR_REPO }}:${{ needs.get-version.outputs.image-tag-prefix }}-core-arm64
            VERSION=${{ needs.get-version.outputs.version }}
          cache-from: |
            type=registry,ref=${{ env.GHCR_REPO }}:cache-phylo-arm64-${{ needs.get-version.outputs.image-tag-prefix }}
            type=registry,ref=${{ env.GHCR_REPO }}:cache-phylo-arm64-main
            type=registry,ref=${{ env.GHCR_REPO }}:cache-core-arm64-${{ needs.get-version.outputs.image-tag-prefix }}
            type=registry,ref=${{ env.GHCR_REPO }}:cache-core-arm64-main
          cache-to: type=registry,ref=${{ env.GHCR_REPO }}:cache-phylo-arm64-${{ needs.get-version.outputs.image-tag-prefix }},mode=max

  # Create multi-arch manifest for phylo
  create-manifest-phylo:
    needs: [get-version, build-phylo-amd64, build-phylo-arm64]
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    outputs:
      phylo-tag: ${{ steps.get-tag.outputs.tag }}

    steps:
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Get phylo tag
        id: get-tag
        run: echo "tag=${{ needs.get-version.outputs.image-tag-prefix }}-phylo" >> $GITHUB_OUTPUT

      - name: Create multi-arch manifest
        run: |
          docker buildx imagetools create \
            --annotation "index:org.opencontainers.image.source=https://github.com/broadinstitute/viral-ngs" \
            --annotation "index:org.opencontainers.image.description=Viral genomics analysis tools - phylogenetics" \
            --annotation "index:org.opencontainers.image.licenses=MIT" \
            --tag ${{ env.GHCR_REPO }}:${{ steps.get-tag.outputs.tag }} \
            ${{ env.GHCR_REPO }}:${{ needs.get-version.outputs.image-tag-prefix }}-phylo-amd64 \
            ${{ env.GHCR_REPO }}:${{ needs.get-version.outputs.image-tag-prefix }}-phylo-arm64

      - name: Create additional tags for main branch
        if: github.ref == 'refs/heads/main'
        run: |
          docker buildx imagetools create \
            --annotation "index:org.opencontainers.image.source=https://github.com/broadinstitute/viral-ngs" \
            --annotation "index:org.opencontainers.image.description=Viral genomics analysis tools - phylogenetics" \
            --annotation "index:org.opencontainers.image.licenses=MIT" \
            --tag ${{ env.GHCR_REPO }}:phylo \
            ${{ env.GHCR_REPO }}:${{ needs.get-version.outputs.image-tag-prefix }}-phylo-amd64 \
            ${{ env.GHCR_REPO }}:${{ needs.get-version.outputs.image-tag-prefix }}-phylo-arm64

      - name: Create version tags
        if: github.ref_type == 'tag'
        run: |
          VERSION="${{ github.ref_name }}"
          MAJOR_MINOR=$(echo "$VERSION" | sed -E 's/^v?([0-9]+\.[0-9]+).*/\1/')

          docker buildx imagetools create \
            --annotation "index:org.opencontainers.image.source=https://github.com/broadinstitute/viral-ngs" \
            --annotation "index:org.opencontainers.image.description=Viral genomics analysis tools - phylogenetics" \
            --annotation "index:org.opencontainers.image.licenses=MIT" \
            --tag ${{ env.GHCR_REPO }}:${VERSION}-phylo \
            ${{ env.GHCR_REPO }}:${{ needs.get-version.outputs.image-tag-prefix }}-phylo-amd64 \
            ${{ env.GHCR_REPO }}:${{ needs.get-version.outputs.image-tag-prefix }}-phylo-arm64

          docker buildx imagetools create \
            --annotation "index:org.opencontainers.image.source=https://github.com/broadinstitute/viral-ngs" \
            --annotation "index:org.opencontainers.image.description=Viral genomics analysis tools - phylogenetics" \
            --annotation "index:org.opencontainers.image.licenses=MIT" \
            --tag ${{ env.GHCR_REPO }}:${MAJOR_MINOR}-phylo \
            ${{ env.GHCR_REPO }}:${{ needs.get-version.outputs.image-tag-prefix }}-phylo-amd64 \
            ${{ env.GHCR_REPO }}:${{ needs.get-version.outputs.image-tag-prefix }}-phylo-arm64

  # ============================================================================
  # MEGA BUILD JOBS - Native multi-arch builds (all tools combined)
  # ============================================================================

  # Build mega for AMD64
  build-mega-amd64:
    needs: [get-version, build-core-amd64]
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    outputs:
      digest: ${{ steps.build.outputs.digest }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push (amd64)
        id: build
        uses: docker/build-push-action@v6
        with:
          context: .
          file: docker/Dockerfile.mega
          platforms: linux/amd64
          push: true
          tags: ${{ env.GHCR_REPO }}:${{ needs.get-version.outputs.image-tag-prefix }}-mega-amd64
          build-args: |
            BASEIMAGE=${{ env.GHCR_REPO }}:${{ needs.get-version.outputs.image-tag-prefix }}-core-amd64
            VERSION=${{ needs.get-version.outputs.version }}
          cache-from: |
            type=registry,ref=${{ env.GHCR_REPO }}:cache-mega-amd64-${{ needs.get-version.outputs.image-tag-prefix }}
            type=registry,ref=${{ env.GHCR_REPO }}:cache-mega-amd64-main
            type=registry,ref=${{ env.GHCR_REPO }}:cache-core-amd64-${{ needs.get-version.outputs.image-tag-prefix }}
            type=registry,ref=${{ env.GHCR_REPO }}:cache-core-amd64-main
          cache-to: type=registry,ref=${{ env.GHCR_REPO }}:cache-mega-amd64-${{ needs.get-version.outputs.image-tag-prefix }},mode=max

  # Build mega for ARM64
  build-mega-arm64:
    needs: [get-version, build-core-arm64]
    runs-on: ubuntu-24.04-arm
    permissions:
      contents: read
      packages: write
    outputs:
      digest: ${{ steps.build.outputs.digest }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push (arm64)
        id: build
        uses: docker/build-push-action@v6
        with:
          context: .
          file: docker/Dockerfile.mega
          platforms: linux/arm64
          push: true
          tags: ${{ env.GHCR_REPO }}:${{ needs.get-version.outputs.image-tag-prefix }}-mega-arm64
          build-args: |
            BASEIMAGE=${{ env.GHCR_REPO }}:${{ needs.get-version.outputs.image-tag-prefix }}-core-arm64
            VERSION=${{ needs.get-version.outputs.version }}
          cache-from: |
            type=registry,ref=${{ env.GHCR_REPO }}:cache-mega-arm64-${{ needs.get-version.outputs.image-tag-prefix }}
            type=registry,ref=${{ env.GHCR_REPO }}:cache-mega-arm64-main
            type=registry,ref=${{ env.GHCR_REPO }}:cache-core-arm64-${{ needs.get-version.outputs.image-tag-prefix }}
            type=registry,ref=${{ env.GHCR_REPO }}:cache-core-arm64-main
          cache-to: type=registry,ref=${{ env.GHCR_REPO }}:cache-mega-arm64-${{ needs.get-version.outputs.image-tag-prefix }},mode=max

  # Create multi-arch manifest for mega
  create-manifest-mega:
    needs: [get-version, build-mega-amd64, build-mega-arm64]
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Create multi-arch manifest
        run: |
          docker buildx imagetools create \
            --annotation "index:org.opencontainers.image.source=https://github.com/broadinstitute/viral-ngs" \
            --annotation "index:org.opencontainers.image.description=Viral genomics analysis tools - all tools combined" \
            --annotation "index:org.opencontainers.image.licenses=MIT" \
            --tag ${{ env.GHCR_REPO }}:${{ needs.get-version.outputs.image-tag-prefix }} \
            ${{ env.GHCR_REPO }}:${{ needs.get-version.outputs.image-tag-prefix }}-mega-amd64 \
            ${{ env.GHCR_REPO }}:${{ needs.get-version.outputs.image-tag-prefix }}-mega-arm64

      - name: Create additional tags for main branch
        if: github.ref == 'refs/heads/main'
        run: |
          docker buildx imagetools create \
            --annotation "index:org.opencontainers.image.source=https://github.com/broadinstitute/viral-ngs" \
            --annotation "index:org.opencontainers.image.description=Viral genomics analysis tools - all tools combined" \
            --annotation "index:org.opencontainers.image.licenses=MIT" \
            --tag ${{ env.GHCR_REPO }}:latest \
            ${{ env.GHCR_REPO }}:${{ needs.get-version.outputs.image-tag-prefix }}-mega-amd64 \
            ${{ env.GHCR_REPO }}:${{ needs.get-version.outputs.image-tag-prefix }}-mega-arm64

      - name: Create version tags
        if: github.ref_type == 'tag'
        run: |
          VERSION="${{ github.ref_name }}"
          MAJOR_MINOR=$(echo "$VERSION" | sed -E 's/^v?([0-9]+\.[0-9]+).*/\1/')

          docker buildx imagetools create \
            --annotation "index:org.opencontainers.image.source=https://github.com/broadinstitute/viral-ngs" \
            --annotation "index:org.opencontainers.image.description=Viral genomics analysis tools - all tools combined" \
            --annotation "index:org.opencontainers.image.licenses=MIT" \
            --tag ${{ env.GHCR_REPO }}:${VERSION} \
            ${{ env.GHCR_REPO }}:${{ needs.get-version.outputs.image-tag-prefix }}-mega-amd64 \
            ${{ env.GHCR_REPO }}:${{ needs.get-version.outputs.image-tag-prefix }}-mega-arm64

          docker buildx imagetools create \
            --annotation "index:org.opencontainers.image.source=https://github.com/broadinstitute/viral-ngs" \
            --annotation "index:org.opencontainers.image.description=Viral genomics analysis tools - all tools combined" \
            --annotation "index:org.opencontainers.image.licenses=MIT" \
            --tag ${{ env.GHCR_REPO }}:${MAJOR_MINOR} \
            ${{ env.GHCR_REPO }}:${{ needs.get-version.outputs.image-tag-prefix }}-mega-amd64 \
            ${{ env.GHCR_REPO }}:${{ needs.get-version.outputs.image-tag-prefix }}-mega-arm64

  # ============================================================================
  # TEST JOBS - Run after corresponding manifests are created
  # Each test runs in its flavor's Docker container (x86 only)
  # ============================================================================

  # Test core (x86)
  test-core:
    needs: [paths-filter, get-version, create-manifest-core]
    if: needs.paths-filter.outputs.core == 'true' || needs.paths-filter.outputs.docker == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      # packages: read not needed - GHCR public images can be pulled without auth

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # No GHCR login needed - public images can be pulled without authentication
      # Pull image with retries to handle transient GHCR connectivity issues
      - name: Pull test image (with retries)
        run: |
          for i in 1 2 3 4 5; do
            echo "Attempt $i: Pulling image..."
            if docker pull ${{ env.GHCR_REPO }}:${{ needs.create-manifest-core.outputs.core-tag }}; then
              echo "Successfully pulled image"
              exit 0
            fi
            echo "Pull failed, waiting 10 seconds before retry..."
            sleep 10
          done
          echo "Failed to pull image after 5 attempts"
          exit 1

      - name: Run core tests
        run: |
          docker run --rm \
            -v ${{ github.workspace }}:/workspace \
            -w /workspace \
            ${{ env.GHCR_REPO }}:${{ needs.create-manifest-core.outputs.core-tag }} \
            pytest tests/unit/core/ \
              -v --tb=short \
              --cov=viral_ngs \
              --cov-report=xml:/workspace/coverage-core.xml \
              -n auto -x

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./coverage-core.xml
          flags: core
          name: codecov-core
          fail_ci_if_error: false

  # Test core (ARM64) - only on PRs with docker changes
  test-core-arm64:
    needs: [paths-filter, get-version, create-manifest-core]
    if: |
      github.event_name == 'pull_request' &&
      needs.paths-filter.outputs.docker == 'true'
    runs-on: ubuntu-24.04-arm
    permissions:
      contents: read
      # packages: read not needed - GHCR public images can be pulled without auth

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # No GHCR login needed - public images can be pulled without authentication
      # Pull image with retries to handle transient GHCR connectivity issues
      - name: Pull test image (with retries)
        run: |
          for i in 1 2 3 4 5; do
            echo "Attempt $i: Pulling image..."
            if docker pull ${{ env.GHCR_REPO }}:${{ needs.create-manifest-core.outputs.core-tag }}; then
              echo "Successfully pulled image"
              exit 0
            fi
            echo "Pull failed, waiting 10 seconds before retry..."
            sleep 10
          done
          echo "Failed to pull image after 5 attempts"
          exit 1

      - name: Run core tests (ARM64)
        run: |
          docker run --rm \
            -v ${{ github.workspace }}:/workspace \
            -w /workspace \
            ${{ env.GHCR_REPO }}:${{ needs.create-manifest-core.outputs.core-tag }} \
            pytest tests/unit/core/ \
              -v --tb=short \
              -n auto -x

  # Test assemble (x86)
  test-assemble:
    needs: [paths-filter, get-version, create-manifest-assemble]
    if: needs.paths-filter.outputs.assemble == 'true' || needs.paths-filter.outputs.core == 'true' || needs.paths-filter.outputs.docker == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      # packages: read not needed - GHCR public images can be pulled without auth

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # No GHCR login needed - public images can be pulled without authentication
      # Pull image with retries to handle transient GHCR connectivity issues
      - name: Pull test image (with retries)
        run: |
          for i in 1 2 3 4 5; do
            echo "Attempt $i: Pulling image..."
            if docker pull ${{ env.GHCR_REPO }}:${{ needs.create-manifest-assemble.outputs.assemble-tag }}; then
              echo "Successfully pulled image"
              exit 0
            fi
            echo "Pull failed, waiting 10 seconds before retry..."
            sleep 10
          done
          echo "Failed to pull image after 5 attempts"
          exit 1

      - name: Run assemble tests
        run: |
          docker run --rm \
            -v ${{ github.workspace }}:/workspace \
            -w /workspace \
            ${{ env.GHCR_REPO }}:${{ needs.create-manifest-assemble.outputs.assemble-tag }} \
            pytest tests/unit/assemble/ \
              -v --tb=short \
              --cov=viral_ngs \
              --cov-report=xml:/workspace/coverage-assemble.xml \
              -n auto -x

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./coverage-assemble.xml
          flags: assemble
          name: codecov-assemble
          fail_ci_if_error: false

  # Test assemble (ARM64) - only on PRs with docker changes
  test-assemble-arm64:
    needs: [paths-filter, get-version, create-manifest-assemble]
    if: |
      github.event_name == 'pull_request' &&
      needs.paths-filter.outputs.docker == 'true'
    runs-on: ubuntu-24.04-arm
    permissions:
      contents: read
      # packages: read not needed - GHCR public images can be pulled without auth

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # No GHCR login needed - public images can be pulled without authentication
      # Pull image with retries to handle transient GHCR connectivity issues
      - name: Pull test image (with retries)
        run: |
          for i in 1 2 3 4 5; do
            echo "Attempt $i: Pulling image..."
            if docker pull ${{ env.GHCR_REPO }}:${{ needs.create-manifest-assemble.outputs.assemble-tag }}; then
              echo "Successfully pulled image"
              exit 0
            fi
            echo "Pull failed, waiting 10 seconds before retry..."
            sleep 10
          done
          echo "Failed to pull image after 5 attempts"
          exit 1

      - name: Run assemble tests (ARM64)
        run: |
          docker run --rm \
            -v ${{ github.workspace }}:/workspace \
            -w /workspace \
            ${{ env.GHCR_REPO }}:${{ needs.create-manifest-assemble.outputs.assemble-tag }} \
            pytest tests/unit/assemble/ \
              -v --tb=short \
              -n auto -x

  # Test classify (x86)
  test-classify:
    needs: [paths-filter, get-version, create-manifest-classify]
    if: needs.paths-filter.outputs.classify == 'true' || needs.paths-filter.outputs.core == 'true' || needs.paths-filter.outputs.docker == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      # packages: read not needed - GHCR public images can be pulled without auth

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # No GHCR login needed - public images can be pulled without authentication
      # Pull image with retries to handle transient GHCR connectivity issues
      - name: Pull test image (with retries)
        run: |
          for i in 1 2 3 4 5; do
            echo "Attempt $i: Pulling image..."
            if docker pull ${{ env.GHCR_REPO }}:${{ needs.create-manifest-classify.outputs.classify-tag }}; then
              echo "Successfully pulled image"
              exit 0
            fi
            echo "Pull failed, waiting 10 seconds before retry..."
            sleep 10
          done
          echo "Failed to pull image after 5 attempts"
          exit 1

      - name: Run classify tests
        run: |
          docker run --rm \
            -v ${{ github.workspace }}:/workspace \
            -w /workspace \
            ${{ env.GHCR_REPO }}:${{ needs.create-manifest-classify.outputs.classify-tag }} \
            pytest tests/unit/classify/ \
              -v --tb=short \
              --cov=viral_ngs \
              --cov-report=xml:/workspace/coverage-classify.xml \
              -n auto -x

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./coverage-classify.xml
          flags: classify
          name: codecov-classify
          fail_ci_if_error: false

  # Test classify (ARM64) - only on PRs with docker changes
  test-classify-arm64:
    needs: [paths-filter, get-version, create-manifest-classify]
    if: |
      github.event_name == 'pull_request' &&
      needs.paths-filter.outputs.docker == 'true'
    runs-on: ubuntu-24.04-arm
    permissions:
      contents: read
      # packages: read not needed - GHCR public images can be pulled without auth

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # No GHCR login needed - public images can be pulled without authentication
      # Pull image with retries to handle transient GHCR connectivity issues
      - name: Pull test image (with retries)
        run: |
          for i in 1 2 3 4 5; do
            echo "Attempt $i: Pulling image..."
            if docker pull ${{ env.GHCR_REPO }}:${{ needs.create-manifest-classify.outputs.classify-tag }}; then
              echo "Successfully pulled image"
              exit 0
            fi
            echo "Pull failed, waiting 10 seconds before retry..."
            sleep 10
          done
          echo "Failed to pull image after 5 attempts"
          exit 1

      - name: Run classify tests (ARM64)
        run: |
          docker run --rm \
            -v ${{ github.workspace }}:/workspace \
            -w /workspace \
            ${{ env.GHCR_REPO }}:${{ needs.create-manifest-classify.outputs.classify-tag }} \
            pytest tests/unit/classify/ \
              -v --tb=short \
              -n auto -x

  # Test phylo (x86)
  test-phylo:
    needs: [paths-filter, get-version, create-manifest-phylo]
    if: needs.paths-filter.outputs.phylo == 'true' || needs.paths-filter.outputs.core == 'true' || needs.paths-filter.outputs.docker == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      # packages: read not needed - GHCR public images can be pulled without auth

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # No GHCR login needed - public images can be pulled without authentication
      # Pull image with retries to handle transient GHCR connectivity issues
      - name: Pull test image (with retries)
        run: |
          for i in 1 2 3 4 5; do
            echo "Attempt $i: Pulling image..."
            if docker pull ${{ env.GHCR_REPO }}:${{ needs.create-manifest-phylo.outputs.phylo-tag }}; then
              echo "Successfully pulled image"
              exit 0
            fi
            echo "Pull failed, waiting 10 seconds before retry..."
            sleep 10
          done
          echo "Failed to pull image after 5 attempts"
          exit 1

      - name: Run phylo tests
        run: |
          docker run --rm \
            -v ${{ github.workspace }}:/workspace \
            -w /workspace \
            ${{ env.GHCR_REPO }}:${{ needs.create-manifest-phylo.outputs.phylo-tag }} \
            pytest tests/unit/phylo/ \
              -v --tb=short \
              --cov=viral_ngs \
              --cov-report=xml:/workspace/coverage-phylo.xml \
              -n auto -x

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./coverage-phylo.xml
          flags: phylo
          name: codecov-phylo
          fail_ci_if_error: false

  # Test phylo (ARM64) - only on PRs with docker changes
  test-phylo-arm64:
    needs: [paths-filter, get-version, create-manifest-phylo]
    if: |
      github.event_name == 'pull_request' &&
      needs.paths-filter.outputs.docker == 'true'
    runs-on: ubuntu-24.04-arm
    permissions:
      contents: read
      # packages: read not needed - GHCR public images can be pulled without auth

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # No GHCR login needed - public images can be pulled without authentication
      # Pull image with retries to handle transient GHCR connectivity issues
      - name: Pull test image (with retries)
        run: |
          for i in 1 2 3 4 5; do
            echo "Attempt $i: Pulling image..."
            if docker pull ${{ env.GHCR_REPO }}:${{ needs.create-manifest-phylo.outputs.phylo-tag }}; then
              echo "Successfully pulled image"
              exit 0
            fi
            echo "Pull failed, waiting 10 seconds before retry..."
            sleep 10
          done
          echo "Failed to pull image after 5 attempts"
          exit 1

      - name: Run phylo tests (ARM64)
        run: |
          docker run --rm \
            -v ${{ github.workspace }}:/workspace \
            -w /workspace \
            ${{ env.GHCR_REPO }}:${{ needs.create-manifest-phylo.outputs.phylo-tag }} \
            pytest tests/unit/phylo/ \
              -v --tb=short \
              -n auto -x

  # ============================================================================
  # DEPLOY JOBS - Copy images from GHCR to Quay after tests pass
  # Uses crane to efficiently copy multi-arch manifests without re-pulling layers
  # ============================================================================

  deploy-to-quay:
    needs: [
      get-version,
      create-manifest-baseimage,
      create-manifest-core,
      create-manifest-assemble,
      create-manifest-classify,
      create-manifest-phylo,
      create-manifest-mega,
      test-core,
      test-assemble,
      test-classify,
      test-phylo
    ]
    if: github.event_name != 'pull_request'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: read

    strategy:
      fail-fast: false
      matrix:
        include:
          - flavor: baseimage
          - flavor: core
          - flavor: assemble
          - flavor: classify
          - flavor: phylo
          - flavor: mega

    steps:
      - name: Install crane
        uses: imjasonh/setup-crane@v0.4

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Log in to Quay.io
        uses: docker/login-action@v3
        with:
          registry: quay.io
          username: ${{ secrets.QUAY_USERNAME }}
          password: ${{ secrets.QUAY_TOKEN }}

      - name: Determine tags to copy
        id: tags
        run: |
          FLAVOR="${{ matrix.flavor }}"

          # Determine the suffix (mega has no suffix)
          if [[ "$FLAVOR" == "mega" ]]; then
            SUFFIX=""
          else
            SUFFIX="-${FLAVOR}"
          fi

          # Build the branch/tag-based tag
          if [[ "${{ github.ref_type }}" == "tag" ]]; then
            # Version tag: copy as version tag
            VERSION="${{ github.ref_name }}"
            echo "src_tag=${VERSION}${SUFFIX}" >> $GITHUB_OUTPUT
            echo "dest_tags=${VERSION}${SUFFIX}" >> $GITHUB_OUTPUT
            # Also create major.minor tag
            MAJOR_MINOR=$(echo "$VERSION" | sed -E 's/^v?([0-9]+\.[0-9]+).*/\1/')
            echo "extra_dest_tag=${MAJOR_MINOR}${SUFFIX}" >> $GITHUB_OUTPUT
          else
            # Branch: copy as branch tag
            BRANCH="${{ needs.get-version.outputs.image-tag-prefix }}"
            echo "src_tag=${BRANCH}${SUFFIX}" >> $GITHUB_OUTPUT
            echo "dest_tags=${BRANCH}${SUFFIX}" >> $GITHUB_OUTPUT
            echo "extra_dest_tag=" >> $GITHUB_OUTPUT
          fi

          # For main branch, also create the "latest" style tag
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            if [[ "$FLAVOR" == "mega" ]]; then
              echo "latest_tag=latest" >> $GITHUB_OUTPUT
            else
              echo "latest_tag=${FLAVOR}" >> $GITHUB_OUTPUT
            fi
          else
            echo "latest_tag=" >> $GITHUB_OUTPUT
          fi

      - name: Copy image to Quay.io
        run: |
          SRC="${{ env.GHCR_REPO }}:${{ steps.tags.outputs.src_tag }}"
          DEST="${{ env.QUAY_REPO }}:${{ steps.tags.outputs.dest_tags }}"

          echo "Copying $SRC -> $DEST"
          crane copy "$SRC" "$DEST"

          # Copy extra version tag if present (e.g., v1.25 for v1.25.0)
          if [[ -n "${{ steps.tags.outputs.extra_dest_tag }}" ]]; then
            EXTRA_DEST="${{ env.QUAY_REPO }}:${{ steps.tags.outputs.extra_dest_tag }}"
            echo "Copying $SRC -> $EXTRA_DEST"
            crane copy "$SRC" "$EXTRA_DEST"
          fi

          # Copy "latest" style tag for main branch
          if [[ -n "${{ steps.tags.outputs.latest_tag }}" ]]; then
            LATEST_DEST="${{ env.QUAY_REPO }}:${{ steps.tags.outputs.latest_tag }}"
            echo "Copying $SRC -> $LATEST_DEST"
            crane copy "$SRC" "$LATEST_DEST"
          fi

      - name: Add expiration label for feature branches
        if: github.ref_type == 'branch' && github.ref_name != 'main'
        run: |
          # Note: crane doesn't support adding labels directly, but Quay.io
          # can be configured with tag expiration policies at the repo level.
          # For now, feature branch images on Quay won't auto-expire.
          # Consider using Quay.io's tag expiration API or repo settings.
          echo "Note: Feature branch images on Quay.io should be cleaned up periodically"
